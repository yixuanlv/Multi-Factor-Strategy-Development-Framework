# 多因子量化策略实操体系

## 数据获取

- 标的池
- 字段：开盘价、收盘价、成交量、换手率、涨跌幅等指标
- 时间/频率：日频/分钟
- 来源：Python调用API，写入到本地数据库存储

## 构造因子

- **输入输出**

  - 输入：原始量价数据，观察期N（参数）
  - 处理：利用历史数据滚动构造因子值
  - 输出：每个因子一张表，其中不同子表对应不同观察期N下的因子
- **量价因子**

  - **价量因子**
    - 出发点：基于价格/涨跌幅/成交量/换手率等
    - 思路：基于端点信息，路径信息，评价指标，回归法，相关性，假设检验，加权法
  - **基本面因子**
  - - 财报，快报，预告：
      - 成长能力：刻画资产的增长
      - 盈利能力：利润增长
      - 营运能力：费用，成本控制
    - 分析师预期
    - 超预期指标
  - **资金面因子**（待扩展）
  - **市场情绪因子**（待扩展）

## 数据处理

* **输入输出**
  * 输入：已构造好的因子数据框
  * 处理：对每一期的因子值，去极值，标准化，中性化
  * 输出：数据处理后的因子数据框

- **去极值**
  - 均值方差法（±3σ）
  - 中位数法（MAD公式：`med±3×1.4826×绝对中位差`）
  - 分位数法（5%-95%分位数截断）
- **标准化**
  - Z-Score转换
- **中性化**
  - 行业中性
    - 行业均值做差
    - 回归取残差（离散）
  - 市值中性：与市值对数回归取残差

## 单因子测试

- **输入输出**

  - 输入：处理后的因子数据框，收益率数据框，调仓周期，分层数量，层内资产配置方式
  - 处理：先计算每期的IC，分组等信息，观察统计所有期的信息，绘制图表
  - 输出：单因子测试报表pdf(ic分析，rank_ic分析，多空回测，多头回测，空头回测)
- **前置准备**

  * 因子下移一行，分析昨日因子值和今日return的关联性
  * 对每个调仓日，计算周期内的因子值，累计收益率，ic， rank_ic，分组，group_ic
- **ic/rank_ic分析**

  - 遍历不同调仓周期，分别取ic， rank_ic
  - 统计：均值/IR/偏度/峰度/t值/p值
  - 绘图：年度IC柱状图，月度IC色阶图，调仓日IC折线图，调仓日累计IC曲线折线图
- **多空测试**

  - 遍历不同调仓周期: 前1-2组多头 vs 末1-2组空头
  - 统计：多空组合的年化收益率，波动率，夏普比率，最大回撤，胜率， pnl
  - 绘图：净值折线图，月度收益率色阶图，调仓日收益率折线图
- **分层多头**

  - 遍历不同的调仓周期，分别取return、excessreturn
  - 统计:前2组和最后2组多头下的年化收益率、波动率、夏普、最大回撤胜率、PNL
  - 绘图:分组净值折线图、分组累计收益率柱状图、调仓日收益率折线图
- **分层空头**

  - 遍历不同的调仓周期，分别取return、excessreturn
  - 统计:前2组和最后2组空头下的年化收益率、波动率、夏普、最大回撤胜率、PNL
  - 绘图:分组净值折线图、分组累计收益率柱状图、调仓日收益率折线图

## 多因子集中测试

- **输入输出**
  - 输入：多个factor数据框，return数据框
  - 处理: 多因子集中测试
  - 输出：多因子集中测试报表
    - Sheet1：因子的测试统计结果，行为因子名称，列名为测试指标，绘制色阶图
    - Sheet2：因子的cum_ic，行为日期，列名为因子名称。绘制折线图
    - Sheet3：第1层多头组合的累计超额收益率，行为日期，列名为因子名称绘制折线图
    - Sheet4：第1层、倒1层多空组合下的累计收益率，行为日期，列名为因子名称。绘制折线图
- **计算统计指标**
  - IC、rank_Ic、因子收益率、group_rank_ic的均值、IR、t值、p值
  - 第1和倒1，第2和倒2组合下的多空组合年化收益率、夏普
  - 第1组、第2组的多头超额年化收益率、超额夏普比率
- 计算不同指标下的日期序列累计ic、多头累计超额收益率、多空累计收益率

## 共线性分析

* **输入输出**

  * 输入: 多个factor数据框，return数据框
  * 处理: 共线性分析
  * 输出: 多因子共线性分析报表
    * 因子收益率相关性（beta_corr）, 截面因子值相关性（factor_corr）
    * cum corr序列，列名为配对因子名称，行索引为日期
* **因子收益率分析**

  * 截面数据上，用上期因子拟合当期收益率，得到回归参数beta估计，即因子收益率
  * 对多个因子的因子收益率序列，计算相关性矩阵betacorr，写入
* **截面因子值相关性分析**

  * 在每一期内，计算不同因子值序列的相关性矩阵。对不同期的相关性矩阵，取均值，作为factorcorrmean，写入
  * 计算两两配对因子的每期相关性corr，将不同配对因子的cum_corr序列合并为一个数据框，写入

## **因子变换**

* 机器学习, 遍历因子组合方式、变换方式
* 基于因子测试结果，做变换，如取绝对值，即折中翻转

## 因子复合

- **输入输出**

  - 输入:多个factor数据框，return数据框，滚动加权窗口数量N，多元回归滚动加权窗口数量M
  - 处理:遍历M和N，计算权重，按行乘以因子值数据框，得到复合因子;标准化，集中测试;
  - 输出:复合因子值excel，每个sheet为1个复合因子数据框;复合因子集中回测报表excel，格式同之前所述;
- **一元回归加权**

  - 思路: 用单因子回归得到的因子收益率，作为权重
  - 方式：

    - 直接取因子收益率序列均值，作为权重，也就是每期权重不变
    - 取截止当前的因子收益率序列均值
    - 取滚动回看N个窗口的因子收益率序列均值
- **排序加权**

  - 排序相加：用因子值在每期的大小顺序序号，替代原有因子值，不同因子等权相加
  - 排序相乘：用因子值在每期的大小顺序序号除以最大序号，替代原有因子值，不同因子直接相乘
- **IC/Rank_IC加权**

  - 思路: 用每期的上期因子值与当期ret的相关系数，作为权重
  - 方法:
    - 直接取 IC 序列均值，作为权重，也就是每期权重不变
    - 取截止鐝企前的 I 序列均值
    - 取滚动回看N个窗口的 IC 序列均值
- **多元回归加权**

  - 思路:用多因子回归得到的因子收益率，作为权重。拟合目标可以取收益率，也可以取收益率截面上的序号标准化之后的值。
  - 方法:
    - 直接取因子收益率序列均值，作为权重，也就是每期权重不变
    - 取截止当前的因子收益率序列均值
    - 取滚动回看M个窗口的因子收益率序列均值
- **PCA分解**

  - 思路:用主成分分析得到的多个主成分，直接作为复合因子
  - PCA分解后得到的因子，可以直接作为复合因子，也可以再次进行多元回归，用因子收益率进行加权

## 构建策略

- **输入输出**

  - 输入: 一个复合后的最终因子数据框，return数据框，资产配置方式，分层数量，调仓周期，多头组号选择
  - 处理: 网格遍历不同参数组合下的多头策略，进行集中回测。
  - 输出: 策略回测报表
    - sheet1: 不同参数组合下策略的回测统计指标，行索引为策略名称，列名为统计指标
    - sheet2: 不同参数组合下策略的累计收益率，行索引为日期，列名为策略名称
- **资产配置方式**

  - 等权配置：在每期多头买入的目标层内，对不同股票等权相加
  - 马科维兹最优权重: 基于目标层内不同股票在调仓日之前的所有历史收益率，计算最大化夏普比率的组合权重
  - 最小方差组合: 数据同上，计算最小化方差的组合权重
  - 最大化收益率组合：数据同上，计算最大化收益率的组合权重
- **分层数量**

  - 根据标的池中股票数量，在某个区间内进行遍历，若一共300个股票分层数量为10层，那么买入的第一层包含30个股票。
- **调仓周期**

  - 在1-60天区间内遍历，如调仓周期为10，那就是每10天调一次仓，计算-次周期内权重配置和收益率。
- **目标组号选择**

  - 如一共有300个股票，分层数量为10层，那么可以选择买入第1层的所有股票，也可以选择买入第2层的所有股票。
- **策略回测**

  - 计算不同参数组合下策略的收益率、累计收益率序列
  - 统计指标
    - 近1日收益、近1周收益、近1月收益、近3月收益
    - 近半年收益、近1年收益、近1年收益、2023年收益
    - 年化收益、年化波动、夏普比率
    - 开仓胜率、开仓盈亏比、年化开仓次数、年化盈利次数
    - 最大回撤、Calmar、最大回撤起止时间
